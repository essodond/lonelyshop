{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
        integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="icon" type="image/png" href="{% static 'image/logo.png' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    {% load static %}
    <link rel="stylesheet" href="{% static 'style/style1.css' %}" />
    <title>Lonely - Boutique en ligne</title>
    <link rel="stylesheet" href="{% static 'style/style.css' %}" />
</head>
<body>
    <header>
    <nav>
       <div class="logo">
            <img src="{% static 'image/logo.png' %}" alt="Lonely Logo" style="width: 40px; height: 40px; object-fit: contain;">
            LONELY
        </div>
        <button class="menu-toggle" aria-label="Toggle menu">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <ul class="nav-links">
            <li><a href="{% url 'index' %}">Nouveautés</a></li>
            <li><a href="{% url 'produit' %}">Produit</a></li>
            <li><a href="{% url 'panier' %}">Panier</a></li>
            <li><a href="{% url 'commande' %}">Commande</a></li>
            <li><a href="#apropos">À propos</a></li>
        </ul>
        <div class="icons">
            <a href="{% url 'panier' %}" class="cart-icon-container" style="position: relative;">
                <span id="cart-badge" class="cart-badge" style="position: absolute; top: -8px; right: -8px; background-color: #ff4444; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px;">{{ cart_count|default:0 }}</span>
                <i class="fa-solid fa-cart-shopping"></i>
            </a>

            <div class="input-wrapper">
                <button type="button" class="icon">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
                <input placeholder="search..." class="input" name="text" type="text">
            </div>
                {% if user.is_authenticated %}
            <div class="user-profile-button">
                <a href="#" class="user-initial" style="background-color: #4285f4; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; text-decoration: none; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                    {{ user.username|first|upper }}
                </a>
                <div class="user-dropdown" style="display: none; position: absolute; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 8px; margin-top: 5px; padding: 8px 0;">
                    <a href="#profile" style="display: block; padding: 8px 16px; color: #333; text-decoration: none;">Profile</a>
                    <a href="{% url 'logout' %}" style="display: block; padding: 8px 16px; color: #333; text-decoration: none;">Déconnexion</a>
                </div>
            </div>
    {% else %}
            <a href="{% url 'login' %}" class="login-button" style="text-decoration: none;">
                <i class="fa-solid fa-user"></i>
            </a>
    {% endif %}
        </div>
    </nav>
    </header>

    <main>
        <!-- Add notification container -->
        <div id="notification" class="notification" style="display: none;">
            <div class="notification-content">
                <i class="fas fa-check-circle"></i>
                <span id="notification-text">Produit ajouté au panier</span>
            </div>
        </div>

        <!-- Add audio element for notification sound -->
        <audio id="notification-sound">
            <source src="{% static 'sounds/notification.mp3' %}" type="audio/mpeg">
            <source src="{% static 'sounds/notification.wav' %}" type="audio/wav">
        </audio>

        <section class="hero">
            <h1>LONELY</h1>
            <p>Découvrez nos produits</p>
        </section>

        <section id="nouveautes" class="products">
            <h2>Nouveautés</h2>
            <div class="product-grid">
                {% for produit in produits %}
                <article class="product-card">
                    {# Image #}
                    {% if produit.image %}
                        <img src="{{ produit.image.url }}" alt="{{ produit.name }}">
                    {% else %}
                        <img src="{% static 'images/im1.jpeg' %}" alt="Image par défaut">
                    {% endif %}
                    
                    {# Nom et Prix #}
                    <h3>{{ produit.name }}</h3>
                    <p>{{ produit.price }} FCFA</p>
                    
                    {# Bouton Voir (ouvre le modal, pas de formulaire) #}
                    <button 
                        type="button"
                        class="btn btn-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#productModal"
                        data-id="{{ produit.id }}"
                        data-name="{{ produit.name }}"
                        data-price="{{ produit.price }}"
                        data-description="{{ produit.description }}"
                        data-image="{{ produit.image.url }}"
                        data-sizes="{{ produit.sizes }}">
                        Ajouter au panier

                    </button>
                </article>
                {% empty %}
                <p class="no-products">Aucun produit disponible pour le moment</p>
                {% endfor %}
            </div>
        </section>


        <section id="apropos" class="about">
            <h2>À propos de Lonely</h2>
            <p>Là où la solitude rencontre l'élégance, Lonely vous invite à découvrir une nouvelle manière de vous habiller. Chaque pièce est soigneusement conçue pour durer, offrant une qualité inégalée et un design intemporel.</p>
            <p>Lonely est une marque minimaliste qui crée des vêtements intemporels pour ceux qui apprécient la simplicité et l'élégance.</p>
        </section>

        <style>
            .notification {
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
            }

            .notification-content {
                background: rgba(255, 255, 255, 0.8);
                backdrop-filter: blur(10px);
                padding: 12px 24px;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .notification i {
                color: #34C759;
            }

            .cart-badge {
                display: inline-block !important;
            }

            @keyframes slideIn {
                from {
                    transform: translateY(100%);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
        </style>
<!-- Modal Bootstrap -->
<style>
.modal-backdrop.show {
    backdrop-filter: blur(10px);
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-dialog {
    max-width: 600px;
    margin: 1.75rem auto;
}

.modal-content {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.18);
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
}

.modal-header {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 20px 30px;
}

.modal-body {
    padding: 30px;
}

.modal-footer {
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    padding: 20px 30px;
}

.btn-close {
    filter: drop-shadow(0 0 2px rgba(0,0,0,0.3));
}
</style>

<!-- MODAL PRODUIT -->
<div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);">
      
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Détails du produit</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <!-- Image -->
        <img id="modalImage" src="" alt="Produit" class="img-fluid mb-4 rounded-3">

        <!-- Prix -->
        <div class="price-container mb-4">
          <p class="old-price text-muted text-decoration-line-through mb-1" id="modalOldPrice" style="display:none;"></p>
          <p class="current-price fw-bold fs-4" id="modalPrice"></p>
        </div>

        <!-- Description -->
        <div class="product-description mb-4">
          <h6 class="fw-bold fs-5">Description</h6>
          <p id="modalDescription" class="text-muted"></p>
        </div>

        <!-- Check if user is authenticated -->
        {% if user.is_authenticated %}
          <!-- Formulaire -->
          <form id="modalAddToCartForm" onsubmit="handleAddToCart(event)">
            {% csrf_token %}
            <input type="hidden" name="id" id="modalProductId">
            <input type="hidden" name="quantite" value="1">
            
            <label for="modalSize" class="form-label fw-bold">Choisir la taille :</label>
            <select id="modalSize" name="taille" class="form-select form-select-lg mb-3" required>
              <!-- Options ajoutées dynamiquement -->
            </select>
          </form>
        {% else %}
          <div class="alert alert-warning" role="alert">
            Veuillez vous <a href="{% url 'login' %}" class="alert-link">connecter</a> pour ajouter des produits au panier.
          </div>
        {% endif %}
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">Annuler</button>
        {% if user.is_authenticated %}
          <button type="submit" form="modalAddToCartForm" class="btn btn-primary btn-lg">Ajouter au panier</button>
        {% else %}
          <a href="{% url 'login' %}" class="btn btn-primary btn-lg">Se connecter</a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
function handleAddToCart(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const productName = document.getElementById('modalTitle').textContent;

    fetch("{% url 'ajouter_panier' %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        // Update cart count
        cartCount = data.cart_count || cartCount + 1;
        updateCartBadge(cartCount);
        
        // Show notification
        showNotification(productName, cartCount);
        
        // Play sound
        playNotificationSound();
        
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
    })
    .catch(error => {
        console.error('Error:', error);
        // Fallback behavior
        cartCount += 1;
        updateCartBadge(cartCount);
        showNotification(productName, cartCount);
        playNotificationSound();
        bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
    });
}
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    var productModal = document.getElementById('productModal');
    productModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;

        var id = button.getAttribute('data-id');
        var name = button.getAttribute('data-name');
        var price = button.getAttribute('data-price');
        var description = button.getAttribute('data-description');
        var image = button.getAttribute('data-image');
        var sizes = button.getAttribute('data-sizes');

        document.getElementById('modalTitle').textContent = name;
        document.getElementById('modalPrice').textContent = price + " FCFA";
        document.getElementById('modalDescription').textContent = description;
        document.getElementById('modalImage').src = image;
        document.getElementById('modalProductId').value = id;

        var sizeSelect = document.getElementById('modalSize');
        sizeSelect.innerHTML = '';
        sizes.split(',').forEach(function(size) {
            var option = document.createElement('option');
            option.value = size.trim();
            option.textContent = size.trim();
            sizeSelect.appendChild(option);
        });
    });
});
</script>


  <script>
    function submitModalForm() {
      const form = document.getElementById('modalAddToCartForm');
      const productName = document.getElementById('modalTitle').textContent;
      const formData = new FormData(form);

      fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
      })
      .then(response => response.json())
      .then(data => {
        // Update cart count
        cartCount = data.cart_count || cartCount + 1;
        updateCartBadge(cartCount);
        
        // Show notification
        showNotification(productName, cartCount);
        
        // Play sound
        playNotificationSound();
        
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
      })
      .catch(error => {
        console.error('Error:', error);
        // Fallback behavior
        cartCount += 1;
        updateCartBadge(cartCount);
        showNotification(productName, cartCount);
        playNotificationSound();
        bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
      });
    }
  </script>
</div>

        <script>
            let cartCount = parseInt({{ cart_count|default:0 }});
            const notificationSound = document.getElementById('notification-sound');

            // Initialize audio context on user interaction
            document.addEventListener('click', function() {
                if (notificationSound.paused) {
                    notificationSound.load();
                }
            }, { once: true });

            async function playNotificationSound() {
                try {
                    await notificationSound.play();
                } catch (err) {
                    console.warn('Could not play notification sound:', err);
                }
            }

            function addToCart(form, productName) {
                const formData = new FormData(form);
                
                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if(data.cart_count !== undefined) {
                        cartCount = data.cart_count;
                    } else {
                        cartCount += 1;
                    }
                    updateCartBadge(cartCount);
                    showNotification(productName, cartCount);
                    playNotificationSound();
                })
                .catch(error => {
                    console.error('Error:', error);
                    cartCount += 1;
                    updateCartBadge(cartCount);
                    showNotification(productName, cartCount);
                    playNotificationSound();
                });
            }

            function showNotification(productName, count) {
                const notification = document.getElementById('notification');
                const notificationText = document.getElementById('notification-text');
                notificationText.textContent = `${productName} ajouté au panier (${count} produit${count > 1 ? 's' : ''})`;
                notification.style.display = 'block';
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }

            function updateCartBadge(quantity) {
                const badge = document.getElementById('cart-badge');
                if(badge) {
                    badge.textContent = quantity;
                    badge.style.display = quantity > 0 ? 'inline-block' : 'none';
                }
            }

            document.addEventListener('DOMContentLoaded', function() {
                updateCartBadge(cartCount);
                const notification = document.getElementById('notification');
                if (notification) {
                    notification.style.display = 'none';
                }
            });
        </script>
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h4>Contact</h4>
                <p>Email: kazalowilliam@gmail.com</p>
                <p>Téléphone: +228 71 60 80 97 </p>
                <p>Téléphone: +228 99 25 85 70 </p>
            </div>
            <div class="footer-section">
                <h4>Suivez-nous</h4>
                <p>Whatsapp</p>
                <p>Facebook</p>
            </div>
        </div>
        <p class="copyright">© 2025 Lonely. Tous droits réservés.</p>
    </footer>
    <script src="{% static 'js/main.js' %}"></script>
    <script>
let selectedProductId = null;
let addForm = null;

function openProductModal(id, name, price, imageUrl, tailles) {
    selectedProductId = id;

    // Mettre à jour contenu du modal
    document.getElementById('modalTitle').textContent = name;
    document.getElementById('modalPrice').textContent = price + ' FCFA';
    document.getElementById('modalImage').src = imageUrl || "{% static 'images/im1.jpeg' %}";

    // Remplir les tailles
    const sizeSelect = document.getElementById('modalSize');
    sizeSelect.innerHTML = "";
    if (Array.isArray(tailles) && tailles.length > 0) {
        tailles.forEach(taille => {
            let opt = document.createElement('option');
            opt.value = taille;
            opt.textContent = taille;
            sizeSelect.appendChild(opt);
        });
    } else {
        let opt = document.createElement('option');
        opt.value = "";
        opt.textContent = "Taille unique";
        sizeSelect.appendChild(opt);
    }

    // Ouvrir le modal
    let modal = new bootstrap.Modal(document.getElementById('productModal'));
    modal.show();
}

// Validation du panier depuis le modal
document.getElementById('confirmAdd').addEventListener('click', function() {
    const selectedSize = document.getElementById('modalSize').value;

    // Création du formData pour fetch
    let formData = new FormData();
    formData.append('id', selectedProductId);
    formData.append('quantite', 1);
    formData.append('taille', selectedSize);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch("{% url 'ajouter_panier' %}", {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(res => res.json())
    .then(data => {
        updateCartBadge(data.cart_count || 1);
        playNotificationSound();
        bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
    })
    .catch(err => console.error(err));
});
</script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"></script>

</body>
</html>